<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEET Biology Quiz</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Acme&family=Dosis:wght@100..800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Modern Variables with Extended Color Palette */
        :root {
            --primary: #7C3AED;
            --primary-light: #8B5CF6;
            --primary-dark: #6D28D9;
            --secondary: #EC4899;
            --secondary-light: #F472B6;
            --accent: #0EA5E9;
            --success: #10B981;
            --error: #EF4444;
            --warning: #F59E0B;
            --background: #F8FAFF;
            --surface: #FFFFFF;
            --text-primary: #1F2937;
            --text-secondary: #4B5563;
            --text-tertiary: #9CA3AF;

            /* Shadows and Effects */
            --shadow-sm: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.07);
            --shadow-lg: 0 10px 15px rgba(0, 0, 0, 0.1);
            --shadow-xl: 0 20px 25px rgba(0, 0, 0, 0.15);
            --shadow-2xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);

            /* Gradients */
            --gradient-primary: linear-gradient(135deg, var(--primary), var(--primary-light));
            --gradient-secondary: linear-gradient(135deg, var(--secondary), var(--secondary-light));
            --gradient-accent: linear-gradient(135deg, var(--accent), var(--primary-light));

            /* Add new variables */
            --border-radius-lg: 24px;
            --transition-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* Enhanced Body Styles */
        body {
            background:
                radial-gradient(circle at 0% 0%, rgba(124, 58, 237, 0.03) 0%, transparent 50%),
                radial-gradient(circle at 100% 100%, rgba(236, 72, 153, 0.03) 0%, transparent 50%),
                var(--background);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            font-family: 'Dosis', sans-serif;
        }

        /* Enhanced quiz card */
        .quiz-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: var(--border-radius-lg);
            padding: 3rem;
            width: 100%;
            max-width: 800px;
            position: relative;
            box-shadow:
                0 10px 15px -3px rgba(0, 0, 0, 0.1),
                0 4px 6px -2px rgba(0, 0, 0, 0.05),
                0 0 0 1px rgba(0, 0, 0, 0.05);
            transform: translateY(0);
            transition: transform 0.4s var(--transition-bounce);
        }

        .quiz-card:hover {
            transform: translateY(-5px);
        }

        /* Enhanced question container */
        .question-container {
            background: var(--surface);
            border-radius: 20px;
            padding: 2.5rem;
            margin: 2rem 0;
            box-shadow: var(--shadow-md);
            border: 1px solid rgba(124, 58, 237, 0.1);
            position: relative;
        }

        .question-container h2 {
            color: var(--text-primary);
            font-size: 1.5rem;
            line-height: 1.4;
            margin-bottom: 2rem;
            font-weight: 600;
        }

        /* Enhanced options styling */
        .options-grid {
            display: grid;
            gap: 1rem;
        }

        .option {
            background: linear-gradient(145deg, #ffffff, #f3f4f6);
            border: 1px solid rgba(124, 58, 237, 0.1);
            padding: 1.5rem 2rem;
            border-radius: 16px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.3s var(--transition-bounce);
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1.1rem;
        }

        .option::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 4px;
            height: 100%;
            background: var(--gradient-primary);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .option:hover {
            transform: translateX(10px);
            background: linear-gradient(145deg, #ffffff, #f0f7ff);
            box-shadow: var(--shadow-md);
        }

        .option:hover::before {
            opacity: 1;
        }

        /* Enhanced progress bar */
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(124, 58, 237, 0.1);
            border-radius: 20px;
            overflow: hidden;
            margin: 1rem 0 3rem 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            box-shadow: 0 0 10px rgba(124, 58, 237, 0.3);
            transition: width 0.5s ease;
        }

        /* Enhanced timer */
        .timer {
            position: absolute;
            top: -20px;
            right: 30px;
            background: var(--surface);
            padding: 0.75rem 1.5rem;
            border-radius: 30px;
            font-weight: 700;
            color: var(--primary);
            border: 2px solid var(--primary-light);
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .timer i {
            color: var(--primary);
            animation: pulse 1s infinite;
        }

        /* Enhanced question number */
        .question-number {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .question-number::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--primary);
            border-radius: 50%;
            display: inline-block;
        }

        /* Enhanced submit button */
        .submit-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            padding: 1.2rem 3rem;
            border-radius: 30px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
            margin: 2rem auto 0;
        }

        .submit-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(124, 58, 237, 0.2);
        }

        /* Enhanced result display */
        #result {
            margin-top: 1.5rem;
            padding: 1rem;
            border-radius: 12px;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s ease;
        }

        #result.correct {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }

        #result.wrong {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        /* Enhanced loading animation */
        .loading {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 4px solid var(--primary-light);
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .quiz-card {
                padding: 2rem;
                margin: 1rem;
            }

            .question-container {
                padding: 1.5rem;
            }

            .option {
                padding: 1.2rem 1.5rem;
            }

            .timer {
                right: 50%;
                transform: translateX(50%);
            }
        }

        /* Animations */
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }

            100% {
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Enhanced option styling with feedback */
        .option {
            background: linear-gradient(145deg, #ffffff, #f3f4f6);
            border: 1px solid rgba(124, 58, 237, 0.1);
            padding: 1.5rem 2rem;
            border-radius: 16px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.3s var(--transition-bounce);
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 1.1rem;
        }

        /* Option indicator */
        .option::after {
            content: '';
            position: absolute;
            left: 1rem;
            width: 20px;
            height: 20px;

            border-radius: 50%;
            transition: all 0.3s ease;
        }

        /* Hover state */
        .option:hover {
            transform: translateX(10px);
            background: linear-gradient(145deg, #ffffff, #f0f7ff);
            box-shadow: var(--shadow-md);
        }

        /* Selected state */
        .option.selected {
            background: linear-gradient(145deg, var(--primary-light), var(--primary));
            color: white;
            transform: translateX(10px);
            box-shadow: var(--shadow-md);
        }

        .option.selected::after {
            background: white;
            border-color: white;
        }

        /* Correct answer feedback */
        .option.correct {
            background: linear-gradient(145deg, var(--success), #34d399);
            color: white;
            transform: scale(1.02);
            pointer-events: none;
        }


        .option.correct::after {
            content: '✓';
            background: white;
            color: var(--success);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Wrong answer feedback */
        .option.wrong {
            background: linear-gradient(145deg, var(--error), #f87171);
            color: white;
            transform: scale(0.98);
            pointer-events: none;
        }

        .option.wrong::after {
            content: '×';
            background: white;
            color: var(--error);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.2rem;
        }

        /* Add animation keyframes */
        @keyframes correctPulse {
            0% {
                transform: scale(1.02);
            }

            50% {
                transform: scale(1.05);
            }

            100% {
                transform: scale(1.02);
            }
        }

        @keyframes wrongShake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        /* Add styles for error message */
        .error-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: rgba(239, 68, 68, 0.9);
            /* Error background color */
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            font-weight: bold;
            z-index: 1000;
            animation: fadeIn 0.5s ease, fadeOut 0.5s ease 2.5s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes fadeOut {
            from {
                opacity: 1;
                transform: translateY(0);
            }

            to {
                opacity: 0;
                transform: translateY(-10px);
            }
        }

        /* Enhanced report button styling */
        .report-btn {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 0.5rem 1.5rem;
            /* Further reduced padding for a smaller button */
            border-radius: 20px;
            /* Slightly smaller border radius for a more compact look */
            font-size: 0.9rem;
            /* Smaller font size for a more compact appearance */
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            /* Reduced gap for icon */
            position: fixed;
            /* Make the button fixed */
            bottom: 20px;
            /* Position from the bottom */
            right: 20px;
            /* Position from the right */
            z-index: 1000;
            /* Ensure it appears above other elements */
        }

        .report-btn:hover {
            transform: translateY(-2px);
            /* Slightly less movement on hover */
            box-shadow: 0 8px 16px rgba(239, 68, 68, 0.2);
            /* Adjusted shadow for a more subtle effect */
        }
    </style>
</head>

<body>
    <div class="quiz-card">
        <div class="progress-bar">
            <div class="progress-fill" style="width: 0%"></div>
        </div>

        <div class="timer">
            <i class="fas fa-clock"></i>
            <span id="timer">30s</span>
        </div>

        <div id="question-number" class="question-number"></div>

        <div class="question-container">
            <h2 id="question-text"></h2>
            <div class="options-grid" id="options-container"></div>
            <div id="result"></div>
        </div>

        <button class="submit-btn" id="next-btn">
            Next Question
            <i class="fas fa-arrow-right ml-2"></i>
        </button>

        <button class="report-btn" id="report-btn">
            Report Issue
            <i class="fas fa-exclamation-circle"></i>
        </button>
    </div>

    <div class="loading" id="loading">
        <div class="loader"></div>
    </div>

    <script>
        let startTime;  // To store the start time of the quiz
        let url
        let method
        let quest
        const studentResponsesList = []
        const chapter_name = localStorage.getItem('selectedChapter')
        const quizAnswers = {}
        const student_id = sessionStorage.getItem("student_id")
        let endTime;    // To store the end time of the quiz

        async function getData(url, method) {
            console.log(method);
            let body;

            // Check if 'quizConfiq' exists in localStorage and parse it
            const quizConfiq = localStorage.getItem("quizConfiq");
            if (quizConfiq) {
                const parsedData = JSON.parse(quizConfiq);
                if (parsedData.chapters) {
                    body = JSON.stringify(parsedData.chapters); // Stringify the body to ensure it's in correct format
                    //console.log("********************************")
                    console.log(parsedData.chapters);
                } else {
                    body = JSON.stringify(parsedData)
                    console.log(body)
                }
            }

            try {
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'X-API-KEY': 'neet_QdrUprUid6I7h7HTvdfOJHib0aSNOy7iUyLYYdFaPcc',  // API Key
                        'Accept': 'application/json',  // Accepting JSON response
                        'Content-Type': 'application/json'  // Sending JSON data
                    },
                    ...(body ? { body } : {}) // Include body if it's defined
                });

                if (!response.ok) {
                    throw new Error(`Response status: ${response.status}`);
                }

                const json = await response.json();
                console.log(json);
                return json;

            } catch (error) {
                console.error(error.message);
            }
        }



        function loadQuestion(questions) {
            const questionNumber = document.getElementById("question-number");
            const questionText = document.getElementById("question-text");
            const optionsContainer = document.getElementById("options-container");
            const nextBtn = document.getElementById("next-btn");
            console.log(questions)
            quest = questions
            if (!questions || !questions.length) {
                console.error('No questions available');
                return;
            }

            const question = questions[currentQuestion];

            if (questionNumber) {
                questionNumber.textContent = `Question ${currentQuestion + 1} of ${questions.length}`;
            }

            if (questionText) {
                questionText.textContent = question.question;
            }

            if (optionsContainer) {
                optionsContainer.innerHTML = "";

                const options = [question.option1, question.option2, question.option3, question.option4];

                options.forEach((option, index) => {
                    const button = document.createElement("button");
                    button.classList.add("option");
                    button.classList.add(`opt${index}`);
                    button.textContent = option;
                    button.addEventListener("click", () => selectOption(index, questions));
                    optionsContainer.appendChild(button);
                });
            }

            if (nextBtn) {
                nextBtn.style.display = "none";
            }

            const result = document.getElementById("result");
            if (result) {
                result.textContent = "";
            }

            startTimer(questions);
        }

        const quiz_type = localStorage.getItem("quiz_type")
        console.log(quiz_type)
        console.log(chapter_name)
        if (quiz_type == "performance-based") {
            url = `/api/v1/performance-based-mock?student_id=${student_id}`
            method = "GET"
        } else if (quiz_type === "custom-topic") {
            url = `/api/v1/random/chapter-ids`;
            method = "POST"
        } else if (quiz_type == "custom-mix") {
            url = `/api/v1/custom-mix/chapter-ids`;
            method = "POST"
        }
        else if (quiz_type == "random-mix") {
            url = `/api/v1/random-mix`;
            method = "GET"
        }
        console.log(url)
        getData(url, method).then(questions => {
            try {

                // Get loading element
                const loading = document.querySelector('.loading');

                if (loading) {
                    // Hide loading when data is ready
                    loading.style.display = 'none';
                }

                startTime = Date.now();
                loadQuestion(questions["data"]);
                nextBtn.addEventListener("click", () => nextQuestion(questions["data"]));
            } catch (error) {
                console.error('Error loading quiz:', error);
                displayErrorMessage("Please try again later.");
            }
        });

        let currentQuestion = 0;
        let score = 0;
        let timer;

        const questionNumber = document.getElementById("question-number");
        const timerElement = document.getElementById("timer");
        const questionText = document.getElementById("question-text");
        const optionsContainer = document.getElementById("options-container");
        const nextBtn = document.getElementById("next-btn");
        const result = document.getElementById("result");

        let response; // Declare response in a broader scope

        function selectOption(index, questions) {
            clearInterval(timer);
            const options = document.querySelectorAll(".option");
            console.log(index + 1)

            const correctIndex = (questions[currentQuestion]['correct-ans']); // Get the correct answer index
            console.log(correctIndex)

            // Check if correctIndex is valid
            if (correctIndex < 0 || correctIndex > options.length) {
                console.error('Invalid correct index:', correctIndex);
                return; // Exit the function if the index is invalid
            }

            // Remove any previous selections
            options.forEach(option => {
                option.classList.remove("selected");
                option.disabled = true; // Disable all options after selection
            });

            // Add selected class first
            options[index].classList.add("selected");

            // Capture the response
            response = { // Update to use the broader scoped response
                student_id: student_id,
                ch_id: questions[currentQuestion]["chapter_id"],
                question_id: questions[currentQuestion].id,
                selected_ans: index + 1
            };
            studentResponsesList.push(response);

            // Print the responses list to the console
            console.log(studentResponsesList);

            // Delay the correct/wrong feedback for better UX
            setTimeout(() => {
                if ((index + 1) == correctIndex) {
                    options[index].classList.add("correct"); // Highlight the selected option if correct
                    options[index].style.animation = "correctPulse 1s ease";
                    score++;
                } else {
                    options[index].classList.add("wrong"); // Highlight the selected option if wrong
                    options[index].style.animation = "wrongShake 0.5s ease";
                    if (correctIndex > 0 && correctIndex <= options.length) {
                        options[correctIndex - 1].classList.add("correct"); // Highlight the correct option
                    }
                }

                // Update progress bar
                const progressFill = document.querySelector(".progress-fill");
                const progress = ((currentQuestion + 1) / questions.length) * 100;
                progressFill.style.width = `${progress}%`;

                // Show next button
                nextBtn.style.display = "flex";
                nextBtn.style.animation = "slideIn 0.5s ease forwards";
            }, 300);
        }

        function nextQuestion(questions) {
            currentQuestion++;

            if (currentQuestion < questions.length) {
                loadQuestion(questions);
            } else {
                // End time once the quiz is completed
                endTime = Date.now();

                // Calculate total time taken (in seconds)
                const totalTime = (endTime - startTime) / 1000; // Convert milliseconds to seconds
                nextBtn.innerText = "Submit";
                validate_answer(studentResponsesList)

                // window.location.href = 'result.html';
            }
        }

        function startTimer(questions) {
            let timeLeft = 30;
            timerElement.textContent = `Time left: ${timeLeft}s`;
            timer = setInterval(() => {
                timeLeft--;
                timerElement.textContent = `Time left: ${timeLeft}s`;
                if (timeLeft === 0) {
                    clearInterval(timer);
                    nextQuestion(questions);
                }
            }, 1000);
        }

        // Add these helper styles
        const styles = `
            .correct {
                background: rgba(16, 185, 129, 0.1);
                color: var(--success);
                padding: 1rem;
                border-radius: 12px;
                margin-top: 1.5rem;
                font-weight: 600;
                text-align: center;
            }
            
            .wrong {
                background: rgba(239, 68, 68, 0.1);
                color: var(--error);
                padding: 1rem;
                border-radius: 12px;
                margin-top: 1.5rem;
                font-weight: 600;
                text-align: center;
            }
            
            @keyframes slideIn {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
        `;

        // Add styles to document
        const styleSheet = document.createElement("style");
        styleSheet.textContent = styles;
        document.head.appendChild(styleSheet);



        function storeResult(submissionData) {
            fetch('/api/v1/quiz-details', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-KEY': 'neet_QdrUprUid6I7h7HTvdfOJHib0aSNOy7iUyLYYdFaPcc'
                },
                body: JSON.stringify(submissionData)
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    // alert('Test submitted successfully!');
                    localStorage.setItem("quiz_id", data["quiz_id"]);

                    // localStorage.setItem("timetaken",time_taken)

                    window.location.href = "result.html"
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error submitting test');
                });
        }


        function validate_answer(submissionData) {
            fetch('/api/v1/validate-answer', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-KEY': 'neet_QdrUprUid6I7h7HTvdfOJHib0aSNOy7iUyLYYdFaPcc'
                },
                body: JSON.stringify(submissionData)
            })
                .then(response => response.json())
                .then(data => {
                    console.log("result" + data)
                    endTime = Date.now()
                    const time_taken = ((endTime - startTime) / 1000)
                    alert('Test submitted successfully!');
                    //console.log(data);
                    const formatted_json = transformQuizData(data, time_taken)


                    storeResult(formatted_json)

                })
                .catch(error => {
                    console.error('Error:', error);
                    // alert('Error submitting test');
                });
        }


        function transformQuizData(inputData, time_taken) {
            // Extract necessary values from inputData
            const student_id = inputData.student_id;
            const score = inputData["score(%)"];
            const total_marks = inputData.total_marks;
            const total_questions = inputData.total_questions;
            const chapterwise_total_question = inputData.chapterwise_total_question;

            // Convert the chapterwise total question keys to a comma-separated string
            const chapter_ids = Object.keys(chapterwise_total_question).join(',');
            console.log(chapter_ids)

            // Construct the output object
            const outputData = {
                student_id: student_id,
                score: score,
                total_marks: total_marks,
                total_questions: total_questions,
                quiz_type: localStorage.getItem("quiz_type"),
                time_taken: time_taken,
                chapter_ids: chapter_ids
            };

            return outputData;
        }
        function displayErrorMessage(message) {
            const errorContainer = document.createElement("div");
            errorContainer.className = "error-message";
            errorContainer.textContent = message;
            document.body.appendChild(errorContainer);

            setTimeout(() => {
                errorContainer.remove();
                //window.location.href = "/dashboard.html"; // Redirect to dashboard after error message disappears
            }, 3000);
        }

        // Event listener for the report button
        document.getElementById("report-btn").addEventListener("click", function () {
            const currentQuestionData = quest[currentQuestion]; // Get the current question data
            console.log(quest[currentQuestion]);
            submissionData = [{
                "source_table": quest[currentQuestion]["chapter_id"],
                "question_id": quest[currentQuestion]["id"],
                "student_id": sessionStorage.getItem("student_id"),
                "status": "Pending"
            }]
            store_reportted_questions(submissionData) 
        });


        function store_reportted_questions(submissionData) {
            fetch('/api/v1/report-questions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-API-KEY': 'neet_QdrUprUid6I7h7HTvdfOJHib0aSNOy7iUyLYYdFaPcc'
                },
                body: JSON.stringify(submissionData)
            })
                .then(response => response.json())
                .then(data => {
                    console.log(data)

                })
                .catch(error => {
                    console.error('Error:', error);
                    // alert('Error submitting test');
                });
        }


    </script>
</body>

</html>